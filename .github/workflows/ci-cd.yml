name: Intelligent CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '20.x'
  PYTHON_VERSION: '3.9'

# Pipeline Stages:
# 1. Setup - Install and cache dependencies
# 2. Quality & Security (Parallel) - Linting, Testing, SonarCloud, and Security Scans
# 3. Build - Build artifacts after all quality checks pass
# 4. Deploy - Deploy to production after build and security checks complete

jobs:
  # Step 1-2: Setup and Dependencies
  setup:
    name: Setup and Cache Dependencies
    runs-on: ubuntu-latest
    outputs:
      cache-hit: ${{ steps.cache-deps.outputs.cache-hit }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # For SonarCloud analysis

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: Cache Dependencies
        id: cache-deps
        uses: actions/cache@v4
        with:
          path: |
            frontend/node_modules
            ~/.cache/pip
          key: ${{ runner.os }}-deps-${{ hashFiles('frontend/package-lock.json', 'backend/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-deps-

      - name: Install Frontend Dependencies
        if: steps.cache-deps.outputs.cache-hit != 'true'
        run: |
          cd frontend
          npm ci

      - name: Install Backend Dependencies
        run: |
          cd backend
          pip install -r requirements.txt

  # Step 3: Frontend Linting
  lint-frontend:
    name: Lint Frontend Code
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Dependencies
        run: |
          cd frontend
          npm ci

      - name: Run ESLint
        run: |
          cd frontend
          npm run lint

  # Step 4: Backend Linting
  lint-backend:
    name: Lint Backend Code
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Dependencies
        run: |
          cd backend
          pip install -r requirements.txt
          pip install flake8 black isort

      - name: Run Flake8
        run: |
          cd backend
          flake8 api --max-line-length=100 --exclude=__pycache__,*.pyc

      - name: Check Black Formatting
        run: |
          cd backend
          black --check api

      - name: Check Import Sorting
        run: |
          cd backend
          isort --check-only api

  # Step 8: Build Frontend
  build-frontend:
    name: Build Frontend Application
    runs-on: ubuntu-latest
    needs: [lint-frontend, test-frontend, sonarcloud]
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Dependencies
        run: |
          cd frontend
          npm ci

      - name: Build Application
        run: |
          cd frontend
          npm run build

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend/dist
          retention-days: 7

  # Step 9: Build Backend
  build-backend:
    name: Build Backend Package
    runs-on: ubuntu-latest
    needs: [lint-backend, test-backend, sonarcloud]
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Dependencies
        run: |
          cd backend
          pip install -r requirements.txt

      - name: Validate Backend Structure
        run: |
          python -c "from backend.api.classification import get_classification; print('âœ“ Backend imports successful')"

  # Step 5: Frontend Unit Tests
  test-frontend:
    name: Frontend Unit Tests
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Dependencies
        run: |
          cd frontend
          npm ci

      - name: Run Tests with Coverage
        run: |
          cd frontend
          npm run test

      - name: Upload Frontend Coverage
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage
          path: frontend/coverage
          retention-days: 7

  # Step 6: Backend Unit Tests
  test-backend:
    name: Backend Unit Tests
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Dependencies
        run: |
          cd backend
          pip install -r requirements.txt

      - name: Run Tests with Coverage
        env:
          RUBINHO_CAMPEAO: "false"
        run: |
          cd backend
          pytest --cov=. --cov-report=xml --cov-report=html --cov-report=term

      - name: Upload Backend Coverage
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage
          path: backend/coverage.xml
          retention-days: 7

  # Step 10: SAST Security Scan (CodeQL)
  security-sast:
    name: SAST Security Analysis
    runs-on: ubuntu-latest
    needs: setup
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript, python

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  # Step 11: Dependency Vulnerability Scan
  security-dependencies:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Frontend - npm audit
        run: |
          cd frontend
          npm audit --audit-level=moderate || true

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Backend - Safety Check
        run: |
          pip install safety
          cd backend
          safety check -r requirements.txt --continue-on-error || true

  # Step 7: SonarCloud Code Quality Analysis
  sonarcloud:
    name: SonarCloud Quality Analysis
    runs-on: ubuntu-latest
    needs: [test-frontend, test-backend]
    if: github.event_name == 'push' || github.event.pull_request.head.repo.full_name == github.repository
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Frontend Coverage
        uses: actions/download-artifact@v4
        with:
          name: frontend-coverage
          path: frontend/coverage

      - name: Download Backend Coverage
        uses: actions/download-artifact@v4
        with:
          name: backend-coverage
          path: backend

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  # Step 12a: Deploy Frontend to Vercel
  deploy-frontend:
    name: Deploy Frontend to Vercel
    runs-on: ubuntu-latest
    needs: [build-frontend, test-frontend, security-sast]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    continue-on-error: true
    environment:
      name: production-frontend
      url: ${{ steps.deploy-frontend.outputs.url }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Deploy Frontend to Vercel
        id: deploy-frontend
        working-directory: ./frontend
        run: |
          url=$(vercel deploy --prod --token=${{ secrets.VERCEL_TOKEN }} --yes)
          echo "url=$url" >> $GITHUB_OUTPUT
          echo "Frontend deployed to: $url"
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_FRONTEND_PROJECT_ID }}

  # Step 12b: Deploy Backend to Vercel
  deploy-backend:
    name: Deploy Backend to Vercel
    runs-on: ubuntu-latest
    needs: [build-backend, test-backend, security-sast]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    continue-on-error: true
    environment:
      name: production-backend
      url: ${{ steps.deploy-backend.outputs.url }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Deploy Backend to Vercel
        id: deploy-backend
        working-directory: ./backend
        run: |
          url=$(vercel deploy --prod --token=${{ secrets.VERCEL_TOKEN }} --yes)
          echo "url=$url" >> $GITHUB_OUTPUT
          echo "Backend deployed to: $url"
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_BACKEND_PROJECT_ID }}
          RUBINHO_CAMPEAO: ${{ secrets.RUBINHO_CAMPEAO || 'false' }}
  

  # Step 13: Update README Badges
  update-badges:
    name: Update README Badges
    runs-on: ubuntu-latest
    needs: [deploy-frontend, deploy-backend]
    if: always() && github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Generate Build Badge
        run: |
          echo "Build badge updated via shields.io"

  # Step 14: Notify Success
  notify:
    name: Pipeline Success Notification
    runs-on: ubuntu-latest
    needs: [update-badges]
    if: always()
    steps:
      - name: Success Message
        run: |
          echo "âœ… CI/CD Pipeline completed successfully!"
          echo "ðŸš€ Application deployed to production"
          echo "ðŸ“Š All quality gates passed"

