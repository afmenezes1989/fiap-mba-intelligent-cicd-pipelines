# Deployment Guide - Vercel with CI/CD

This guide explains how to deploy your F1 Classification app to Vercel using GitHub Actions.

## Overview

The deployment is fully automated through GitHub Actions:
- Push to `main` branch triggers CI/CD pipeline
- All quality checks must pass (tests, security, linting)
- Vercel CLI deploys directly from GitHub Actions
- Feature flags can be controlled via GitHub Secrets or Vercel Dashboard

---

## Prerequisites

1. GitHub account with repository created
2. Vercel account (free tier)
3. Vercel CLI installed locally (for initial setup)

---

## Step 1: Link Project to Vercel

### 1.1 Install Vercel CLI

```bash
npm install -g vercel@latest
```

### 1.2 Login to Vercel

```bash
vercel login
```

### 1.3 Link Your Project

```bash
cd /Users/andre.menezes/workspace/f1-classification-cicd
vercel link
```

Follow the prompts:
- Set up and link to an existing project? **N**
- What's your project's name? **f1-classification-cicd**
- In which directory is your code located? **./**
- Want to override settings? **N**

This creates `.vercel/project.json` with your project IDs.

---

## Step 2: Configure GitHub Secrets

Go to your GitHub repository:
```
https://github.com/YOUR_USERNAME/f1-classification-cicd/settings/secrets/actions
```

Add these secrets:

### Required Secrets:

| Secret Name | Description | How to Get |
|-------------|-------------|------------|
| `VERCEL_TOKEN` | Vercel API token | See below |
| `VERCEL_ORG_ID` | Your organization ID | From `.vercel/project.json` |
| `VERCEL_PROJECT_ID` | Your project ID | From `.vercel/project.json` |

### Optional Secret:

| Secret Name | Value | Purpose |
|-------------|-------|---------|
| `RUBINHO_CAMPEAO` | `true` or `false` | Feature flag for Rubinho champion mode |

### Get Vercel Token:

1. Go to https://vercel.com/account/tokens
2. Click "Create Token"
3. Name: `GitHub Actions CI/CD`
4. Scope: **Full Account**
5. Expiration: Set as needed
6. Copy the token immediately (shown only once)

### Get Project IDs:

```bash
cat .vercel/project.json
```

You'll see:
```json
{
  "orgId": "team_xxxxxxxxxxxxx",
  "projectId": "prj_xxxxxxxxxxxxx"
}
```

Copy these values to GitHub Secrets.

---

## Step 3: Configure Environment Variables in Vercel

Even though we're using CI/CD, configure the environment variables in Vercel Dashboard for direct deployments and preview branches.

### In Vercel Dashboard:

1. Go to https://vercel.com/dashboard
2. Select your project
3. Go to **Settings** → **Environment Variables**

Add:

| Name | Value | Environment |
|------|-------|-------------|
| `RUBINHO_CAMPEAO` | `false` | Production, Preview, Development |

---

## Step 4: Deploy

### Automatic Deployment (via GitHub Actions):

```bash
# Make any change
echo "# Test" >> README.md

# Commit and push
git add .
git commit -m "feat: trigger deployment"
git push origin main
```

The GitHub Actions pipeline will:
1. Run all 14 CI/CD steps
2. If all pass, deploy to Vercel
3. Output the deployment URL

### Manual Deployment (local):

```bash
# Deploy to preview
vercel

# Deploy to production
vercel --prod
```

---

## Step 5: Verify Deployment

### Check GitHub Actions:

1. Go to: `https://github.com/YOUR_USERNAME/f1-classification-cicd/actions`
2. Click on the latest workflow run
3. Check that all 14 steps completed successfully
4. Look for the deployment URL in the "Deploy to Vercel" step

### Test Your App:

1. Visit the deployment URL
2. Verify the F1 classification table loads
3. Check the API: `https://your-app.vercel.app/api/classification`

---

## How It Works

### Project Structure for Vercel:

```
f1-classification-cicd/
├── api/
│   └── index.py              # Vercel Serverless Function (Backend API)
├── frontend/
│   └── dist/                 # Static files (generated by build)
├── backend/
│   └── api/
│       └── classification.py # Business logic
├── requirements.txt          # Python dependencies (root level)
├── vercel.json              # Vercel configuration
└── .github/workflows/
    └── ci-cd.yml            # CI/CD pipeline with deployment
```

### What Happens During Deployment:

1. **Frontend Build:**
   - `cd frontend && npm ci && npm run build`
   - Outputs to `frontend/dist/`
   - Served as static files via Vercel CDN

2. **Backend Deploy:**
   - `api/index.py` becomes a serverless function
   - Imports business logic from `backend/api/`
   - Available at `/api/*` routes

3. **Environment Variables:**
   - Loaded from Vercel Dashboard
   - Or from GitHub Secrets during CI/CD build
   - Feature flags controlled at runtime

---

## CI/CD Pipeline Steps

The deployment only happens after all these pass:

```
1. Setup & Cache
2. Lint Frontend (ESLint)
3. Lint Backend (Flake8, Black)
4. Build Frontend
5. Build Backend
6. Frontend Tests (15+ tests)
7. Backend Tests (12+ tests)
8. SAST Security Scan (CodeQL)
9. Dependency Scan
10. SonarCloud Analysis (optional)
11. Deploy to Vercel ← YOU ARE HERE
12. Update Badges
13. Success Notification
```

---

## Feature Flag Control

### Method 1: Via GitHub Secrets (Recommended for CI/CD)

1. Add `RUBINHO_CAMPEAO` secret in GitHub
2. Push to main branch
3. CI/CD builds with the feature flag value
4. Deployed to Vercel

### Method 2: Via Vercel Dashboard

1. Go to Vercel Dashboard → Settings → Environment Variables
2. Change `RUBINHO_CAMPEAO` value
3. Redeploy from Vercel Dashboard or push new commit

### Method 3: Via Vercel CLI

```bash
vercel env add RUBINHO_CAMPEAO production
# Enter: true or false
```

---

## Troubleshooting

### Issue: Pipeline fails at deployment step

**Check:**
```bash
# Verify secrets are set in GitHub
# Go to: Settings → Secrets and variables → Actions
```

Required secrets:
- `VERCEL_TOKEN`
- `VERCEL_ORG_ID`
- `VERCEL_PROJECT_ID`

### Issue: API returns 404

**Solution:**
- Verify `api/index.py` exists
- Check `requirements.txt` in root directory
- Ensure imports work: `from backend.api.classification import get_classification`

### Issue: Frontend doesn't load

**Solution:**
```bash
# Test build locally
cd frontend
npm install
npm run build

# Check output
ls dist/
```

### Issue: Feature flag doesn't work

**Check environment variables:**
1. In Vercel Dashboard
2. In GitHub Secrets (if using CI/CD)
3. Verify spelling: `RUBINHO_CAMPEAO` (no typos)

---

## Deployment Environments

### Production

- Branch: `main`
- URL: `https://f1-classification-cicd.vercel.app`
- Deployed via CI/CD on push to main

### Preview

- Branch: Any other branch
- URL: Auto-generated by Vercel
- Can be triggered manually: `vercel`

### Development

- Local only
- Run: `npm run dev` (frontend) + `uvicorn` (backend)

---

## Rollback

### Via Vercel Dashboard:

1. Go to **Deployments** tab
2. Find previous successful deployment
3. Click **⋯** → **Promote to Production**

### Via Vercel CLI:

```bash
# List deployments
vercel list

# Promote a specific deployment
vercel promote <deployment-url>
```

---

## Cost

All components are **FREE** for this project:

- **GitHub Actions**: 2,000 minutes/month free
- **Vercel**: Unlimited deployments for hobby projects
- **Bandwidth**: 100 GB/month free on Vercel

---

## Security Notes

1. **Never commit** `.vercel/` directory (already in `.gitignore`)
2. **Never commit** Vercel tokens or secrets
3. Use GitHub Secrets for all sensitive data
4. Rotate tokens periodically

---

## Next Steps

1. Push code to GitHub
2. Watch the CI/CD pipeline run
3. Access your deployed app
4. Toggle feature flags
5. Present to your MBA class!

---

## Support

- Vercel Docs: https://vercel.com/docs
- GitHub Actions Docs: https://docs.github.com/en/actions
- Project Issues: https://github.com/YOUR_USERNAME/f1-classification-cicd/issues

